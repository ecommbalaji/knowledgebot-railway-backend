name: Deploy to Railway

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Railway CLI
        run: |
          npm install -g @railway/cli@latest

      - name: Deploy all services
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          # Railway CLI authentication:
          # - RAILWAY_TOKEN: Project token (for project-level operations like railway up)
          # - RAILWAY_API_TOKEN: Account token (alternative, but RAILWAY_TOKEN takes precedence)
          # Note: For 'railway up', you need a PROJECT TOKEN (RAILWAY_TOKEN), not an Account token
          
          # Deploy each service
          echo "Deploying API Gateway..."
          railway up --service api-gateway --detach || echo "⚠️ Service 'api-gateway' may not exist or needs manual setup"
          
          echo "Deploying Knowledgebase Ingestion..."
          railway up --service knowledgebase-ingestion --detach || echo "⚠️ Service 'knowledgebase-ingestion' may not exist or needs manual setup"
          
          echo "Deploying Website Scraping..."
          railway up --service website-scraping --detach || echo "⚠️ Service 'website-scraping' may not exist or needs manual setup"
          
          echo "Deploying Chatbot Orchestration..."
          railway up --service chatbot-orchestration --detach || echo "⚠️ Service 'chatbot-orchestration' may not exist or needs manual setup"
          
          echo "✅ Deployment process complete!"
          echo ""
          echo "ℹ️  IMPORTANT NOTES:"
          echo "  - If you see 'Project Token not found' errors:"
          echo "    1. Go to Railway → Your Project → Settings → Tokens"
          echo "    2. Create a PROJECT TOKEN (not an Account token)"
          echo "    3. Add it as RAILWAY_TOKEN secret in GitHub (not RAILWAY_API_TOKEN)"
          echo "  - Services must be created manually in Railway dashboard first"
          echo "  - See README.md for detailed setup instructions"
